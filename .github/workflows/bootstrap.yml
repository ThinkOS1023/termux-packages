name: Simple Bootstrap Generation

on:
  workflow_dispatch:  # 支持手动触发

permissions: {} # 默认没有特殊权限

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Build bootstrap archive
        run: |
          echo "Building bootstrap for architecture: aarch64"
          # 模拟生成一个 bootstrap zip 文件
          mkdir -p bootstrap
          echo "Bootstrap content" > bootstrap/bootstrap-aarch64.txt
          zip -r bootstrap/bootstrap-aarch64.zip bootstrap/

      - name: Store bootstrap archive as artifact
        uses: actions/upload-artifact@v3  # 使用v3版本
        with:
          name: bootstrap-archive-${{ github.sha }}
          path: bootstrap/*.zip

  publish:
    permissions:
      contents: write  # 上传内容到 GitHub Releases
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Fetch bootstrap archive
        uses: actions/download-artifact@v3  # 使用v3版本
        with:
          path: ./bootstrap/

      - name: Create a new tag
        id: get_tag
        run: |
          new_tag="bootstrap-$(date "+%Y.%m.%d")"
          existing_tag_revision=$(git tag | grep "$new_tag" | sort -r | head -n 1 | cut -d- -f3 | cut -dr -f2)
          if [ -n "$existing_tag_revision" ]; then
            tag_rev=$((existing_tag_revision + 1))
          else
            tag_rev=1
          fi
          new_tag="${new_tag}-r${tag_rev}+apt.android-7"
          echo "tag_name=$new_tag" >> $GITHUB_OUTPUT

      - name: Publish bootstrap archive to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.get_tag.outputs.tag_name }} --title "Bootstrap archives for Termux"
          for file in ./bootstrap/*.zip; do
            gh release upload ${{ steps.get_tag.outputs.tag_name }} "$file"
          done
